name: Publish Skill (Reusable)

on:
  workflow_call:
    inputs:
      skill_name:
        description: "Name of the skill directory (e.g., youdotcom-cli)"
        required: true
        type: string
      bump_type:
        description: "Version bump type: major, minor, or patch"
        required: true
        type: string
    secrets:
      PUBLISH_TOKEN:
        description: "GitHub token with permission to push to protected branches"
        required: true

jobs:
  update-version:
    name: Update Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump-version.outputs.version }}
      skill_name: ${{ inputs.skill_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PUBLISH_TOKEN }}
          fetch-depth: 0

      - name: Validate inputs
        run: |
          # Validate bump type (workflow-specific validation)
          if [[ ! "${{ inputs.bump_type }}" =~ ^(major|minor|patch)$ ]]; then
            echo "‚ùå Error: bump_type must be 'major', 'minor', or 'patch'"
            echo "Provided: ${{ inputs.bump_type }}"
            exit 1
          fi

          echo "‚úÖ Input validation passed"
          echo "Note: Skill structure validation happens in the next step"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Validate skill structure
        run: |
          echo "üîç Validating skill: ${{ inputs.skill_name }}"

          # Get JSON output
          RESULT=$(bunx @plaited/development-skills validate-skill "skills/${{ inputs.skill_name }}" --json)

          # Pretty print results
          echo "$RESULT" | jq .

          # Check if skill is valid
          IS_VALID=$(echo "$RESULT" | jq -r '.[0].valid')

          if [ "$IS_VALID" != "true" ]; then
            echo ""
            echo "‚ùå Skill validation failed for: ${{ inputs.skill_name }}"
            ERRORS=$(echo "$RESULT" | jq -r '.[0].errors | join(", ")')
            echo "Errors: $ERRORS"
            exit 1
          fi

          echo "‚úÖ Skill structure is valid"

      - name: Bump and update version
        id: bump-version
        run: |
          # Use the yaml package to read, bump, and write version
          bun run - <<'SCRIPT'
          import { readFileSync, writeFileSync } from 'fs';
          import { parse, stringify } from 'yaml';

          const skillName = process.env.SKILL_NAME;
          const bumpType = process.env.BUMP_TYPE;
          const filePath = `skills/${skillName}/SKILL.md`;

          // Read and parse SKILL.md
          const content = readFileSync(filePath, 'utf8');

          // Split frontmatter and body
          const parts = content.split(/^---\n/m);
          if (parts.length < 3) {
            console.error('‚ùå Error: Invalid SKILL.md format (missing frontmatter)');
            process.exit(1);
          }

          // Parse YAML frontmatter (parts[0] is empty, parts[1] is frontmatter)
          const frontmatter = parse(parts[1]);

          const currentVersion = frontmatter.metadata.version;
          console.log(`üìå Current version: ${currentVersion}`);

          // Parse version
          const match = currentVersion.match(/^(\d+)\.(\d+)\.(\d+)$/);
          if (!match) {
            console.error(`‚ùå Error: Invalid version format: ${currentVersion}`);
            process.exit(1);
          }

          let [_, major, minor, patch] = match;
          major = parseInt(major);
          minor = parseInt(minor);
          patch = parseInt(patch);

          // Bump version
          switch (bumpType) {
            case 'major':
              major++;
              minor = 0;
              patch = 0;
              console.log('üöÄ Major version bump');
              break;
            case 'minor':
              minor++;
              patch = 0;
              console.log('‚ú® Minor version bump');
              break;
            case 'patch':
              patch++;
              console.log('üîß Patch version bump');
              break;
          }

          const newVersion = `${major}.${minor}.${patch}`;
          console.log(`üì¶ New version: ${newVersion}`);

          // Update frontmatter
          frontmatter.metadata.version = newVersion;

          // Write back to file
          const newContent = `---\n${stringify(frontmatter)}---\n${parts.slice(2).join('---\n')}`;
          writeFileSync(filePath, newContent, 'utf8');

          console.log(`‚úÖ Version updated successfully to ${newVersion}`);

          // Output for next steps
          const output = `version=${newVersion}\n`;
          writeFileSync(process.env.GITHUB_OUTPUT, output, { flag: 'a' });
          SCRIPT
        env:
          SKILL_NAME: ${{ inputs.skill_name }}
          BUMP_TYPE: ${{ inputs.bump_type }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version changes
        run: |
          VERSION="${{ steps.bump-version.outputs.version }}"
          SKILL_NAME="${{ inputs.skill_name }}"
          BUMP_TYPE="${{ inputs.bump_type }}"

          git add "skills/${SKILL_NAME}/SKILL.md"

          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit (version already up-to-date)"
          else
            git commit -m "chore(${SKILL_NAME}): ${BUMP_TYPE} version bump to ${VERSION} [skip ci]"
            git pull origin ${{ github.ref_name }} --ff
            git push origin HEAD:${{ github.ref_name }}
            echo "‚úÖ Version changes committed and pushed"
          fi
