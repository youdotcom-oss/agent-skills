name: Publish Skill (Reusable)

on:
  workflow_call:
    inputs:
      skill_name:
        description: "Name of the skill directory (e.g., youdotcom-cli)"
        required: true
        type: string
      bump_type:
        description: "Version bump type: major, minor, or patch"
        required: true
        type: string
    secrets:
      PUBLISH_TOKEN:
        description: "GitHub token with permission to push to protected branches"
        required: true

jobs:
  update-version:
    name: Update Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump-version.outputs.version }}
      skill_name: ${{ inputs.skill_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PUBLISH_TOKEN }}
          fetch-depth: 0

      - name: Validate inputs
        run: |
          # Validate bump type
          if [[ ! "${{ inputs.bump_type }}" =~ ^(major|minor|patch)$ ]]; then
            echo "‚ùå Error: bump_type must be 'major', 'minor', or 'patch'"
            echo "Provided: ${{ inputs.bump_type }}"
            exit 1
          fi

          # Validate skill name (kebab-case)
          if [[ ! "${{ inputs.skill_name }}" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
            echo "‚ùå Error: Skill name must be in kebab-case (e.g., youdotcom-cli)"
            echo "Provided: ${{ inputs.skill_name }}"
            exit 1
          fi

          # Validate skill directory exists
          if [[ ! -d "skills/${{ inputs.skill_name }}" ]]; then
            echo "‚ùå Error: Skill directory not found: skills/${{ inputs.skill_name }}"
            exit 1
          fi

          # Validate SKILL.md exists
          if [[ ! -f "skills/${{ inputs.skill_name }}/SKILL.md" ]]; then
            echo "‚ùå Error: SKILL.md not found in skills/${{ inputs.skill_name }}/"
            exit 1
          fi

          echo "‚úÖ Input validation passed"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Validate skill structure
        run: |
          echo "üîç Validating skill: ${{ inputs.skill_name }}"
          bunx @plaited/development-skills validate-skill "skills/${{ inputs.skill_name }}"

          if [ $? -eq 0 ]; then
            echo "‚úÖ Skill structure is valid"
          else
            echo "‚ùå Skill validation failed"
            bunx @plaited/development-skills validate-skill "skills/${{ inputs.skill_name }}" --json
            exit 1
          fi

      - name: Install yq
        run: |
          YQ_VERSION="v4.52.2"
          sudo wget -qO /usr/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/bin/yq

      - name: Bump version
        id: bump-version
        run: |
          SKILL_FILE="skills/${{ inputs.skill_name }}/SKILL.md"
          BUMP_TYPE="${{ inputs.bump_type }}"

          # Get current version from SKILL.md
          CURRENT_VERSION=$(yq eval '.metadata.version' "${SKILL_FILE}")

          echo "üìå Current version: ${CURRENT_VERSION}"

          # Parse current version
          if [[ ! "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "‚ùå Error: Invalid version format in SKILL.md: ${CURRENT_VERSION}"
            exit 1
          fi

          MAJOR="${BASH_REMATCH[1]}"
          MINOR="${BASH_REMATCH[2]}"
          PATCH="${BASH_REMATCH[3]}"

          # Bump version based on type
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              echo "üöÄ Major version bump"
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "‚ú® Minor version bump"
              ;;
            patch)
              PATCH=$((PATCH + 1))
              echo "üîß Patch version bump"
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "üì¶ New version: ${NEW_VERSION}"

          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT

      - name: Update SKILL.md version
        run: |
          VERSION="${{ steps.bump-version.outputs.version }}"
          SKILL_FILE="skills/${{ inputs.skill_name }}/SKILL.md"

          echo "üìù Updating version in ${SKILL_FILE} to ${VERSION}"

          # Update version using yq (safe YAML manipulation)
          yq eval '.metadata.version = "'"${VERSION}"'"' -i "${SKILL_FILE}"

          # Verify the update
          UPDATED_VERSION=$(yq eval '.metadata.version' "${SKILL_FILE}")
          if [[ "${UPDATED_VERSION}" != "${VERSION}" ]]; then
            echo "‚ùå Error: Version update failed. Expected ${VERSION}, got ${UPDATED_VERSION}"
            exit 1
          fi

          echo "‚úÖ Version updated successfully to ${VERSION}"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version changes
        run: |
          VERSION="${{ steps.bump-version.outputs.version }}"
          SKILL_NAME="${{ inputs.skill_name }}"
          BUMP_TYPE="${{ inputs.bump_type }}"

          git add "skills/${SKILL_NAME}/SKILL.md"

          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit (version already up-to-date)"
          else
            git commit -m "chore(${SKILL_NAME}): ${BUMP_TYPE} version bump to ${VERSION} [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "‚úÖ Version changes committed and pushed"
          fi

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: update-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.ref_name }}

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.update-version.outputs.version }}"
          SKILL_NAME="${{ needs.update-version.outputs.skill_name }}"
          TAG="${SKILL_NAME}@v${VERSION}"

          echo "üè∑Ô∏è Creating release: ${TAG}"

          # Generate release notes filtered to skill directory
          RELEASE_NOTES=$(git log --pretty=format:"- %s (%h)" --grep="^.*${SKILL_NAME}" -- "skills/${SKILL_NAME}" | head -20)

          if [[ -z "$RELEASE_NOTES" ]]; then
            RELEASE_NOTES="Release ${VERSION} of ${SKILL_NAME}"
          fi

          # Create release
          gh release create "${TAG}" \
            --title "${SKILL_NAME} v${VERSION}" \
            --notes "${RELEASE_NOTES}" \
            --target ${{ github.ref_name }}

          echo "‚úÖ Release created: ${TAG}"
